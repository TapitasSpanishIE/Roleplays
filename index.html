<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LC Oral Master - Se√±or Mart√≠n</title>
    <style>
        :root { --primary: #1a237e; --secondary: #c62828; }
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #e5ddd5; }
        header { background: var(--primary); color: white; padding: 10px; text-align: center; flex-shrink: 0; font-weight: bold; }
        .selector { display: flex; overflow-x: auto; gap: 8px; padding: 10px; background: #fff; border-bottom: 2px solid #ccc; flex-shrink: 0; }
        .rp-btn { min-width: 90px; padding: 10px; background: #f8f8f8; border: 1px solid #999; border-radius: 8px; font-size: 13px; text-align: center; cursor: pointer; }
        .active { background: var(--secondary) !important; color: white; }
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .bubble { max-width: 80%; padding: 12px; border-radius: 12px; font-size: 16px; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .ex { align-self: flex-start; background: white; border-bottom-left-radius: 2px; }
        .st { align-self: flex-end; background: #dcf8c6; border-bottom-right-radius: 2px; }
        
        #next-trigger { 
            display: none; margin: 10px auto; padding: 15px 30px; background: var(--secondary); 
            color: white; border: none; border-radius: 30px; font-weight: bold; font-size: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; flex-shrink: 0;
        }

        .input-area { background: white; padding: 15px 15px 40px 15px; display: flex; gap: 10px; border-top: 2px solid var(--primary); }
        input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ccc; font-size: 17px; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px 18px; border-radius: 50%; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>

<header>Se√±or Mart√≠n: Simulador Oficial SEC</header>

<div class="selector">
    <div class="rp-btn" id="b1" onclick="start(1)">üè† 1. C√°ceres</div>
    <div class="rp-btn" id="b2" onclick="start(2)">üíª 2. √Åvila</div>
    <div class="rp-btn" id="b3" onclick="start(3)">üöê 3. Caravana</div>
    <div class="rp-btn" id="b4" onclick="start(4)">‚ôªÔ∏è 4. Pl√°sticos</div>
    <div class="rp-btn" id="b5" onclick="start(5)">üöó 5. Aver√≠a</div>
</div>

<div id="chat"></div>

<button id="next-trigger" onclick="avanzarManual()">Escuchar examinador ‚è©</button>

<div class="input-area">
    <button class="btn" id="mic" onclick="runMic()">üéôÔ∏è</button>
    <input type="text" id="box" placeholder="Tu respuesta aparecer√° aqu√≠...">
    <button class="btn" onclick="send()">‚ñ∂Ô∏è</button>
</div>

<script>
    let current = null; 
    let step = 0;
    let recognition;

    const data = {
        1: ["¬°Hola, d√≠game!", "Entiendo que vas a estudiar un a√±o en C√°ceres. ¬øEn qu√© parte de la ciudad querr√≠as vivir?", "¬øPor qu√©?", "Tienes raz√≥n, pero C√°ceres es peque√±a y se puede ir andando a la Plaza Mayor en media hora desde las afueras.", ["¬øHas estado alguna vez en C√°ceres?", "¬øQu√© es lo que m√°s te gusta de vivir en Espa√±a?", "¬øPor qu√© quieres estudiar en Espa√±a?"], "Hemos terminado, gracias."],
        2: ["Buenos d√≠as. ¬øEn qu√© puedo ayudarte?", "Veo que tienes un problema con el port√°til. ¬øQu√© le ha pasado exactamente a la pantalla?", "¬°Qu√© mala suerte! ¬øTienes copia de seguridad?", "Tengo una oferta: te lo arreglo hoy por 300‚Ç¨. ¬øQu√© te parece?", ["¬øUsas mucho el port√°til?", "¬øPrefieres Mac o Windows?", "¬øHas tenido problemas antes?"], "Examen finalizado."],
        3: ["Hola, buenos d√≠as. ¬øQuieres alquilar una autocaravana?", "¬øQui√©n va a conducir?", "¬øTu madre ha tenido alg√∫n accidente?", "Castilla-La Mancha es preciosa. ¬øQu√© ciudades quer√©is visitar?", ["¬øTe gusta acampar?", "¬øPrefieres verano o invierno?", "¬øHas conducido algo grande?"], "Role Play completado."],
        4: ["¬°Hola! Pareces muy contento/a. ¬øPor qu√©?", "¬øSabes cu√°ndo entrar√° en vigor la prohibici√≥n del Parlamento Europeo?", "¬øQu√© materiales crees que se deber√≠an usar?", "En casa reciclamos siempre. ¬øY t√∫?", ["¬øTu colegio recicla?", "¬øQu√© opinas del cambio clim√°tico?", "¬øUsas botellas de cristal?"], "¬°Muy bien!"],
        5: ["¬°Hola, buenas tardes!", "Debes estar entre Medina y Tordesillas, cerca de la salida 156. ¬øVes alguna se√±al?", "¬øMe puedes describir tu coche?", "¬øLlevas mucho tiempo esperando?", ["¬øHas llamado a tu familia?", "¬øSabes cambiar una rueda?", "¬øConoces esta zona?"], "El mec√°nico llegar√° pronto."]
    };

    function playAudio(archivo, fallbackTxt) {
        let audio = new Audio(archivo);
        audio.play().catch(() => speak(fallbackTxt));
    }

    function speak(txt) {
        window.speechSynthesis.cancel();
        let m = new SpeechSynthesisUtterance(txt);
        m.lang = 'es-ES'; m.rate = 0.85;
        window.speechSynthesis.speak(m);
    }

    function start(id) {
        current = id; step = 0;
        document.querySelectorAll('.rp-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('b'+id).classList.add('active');
        document.getElementById('chat').innerHTML = "";
        document.getElementById('next-trigger').style.display = "none";
        next();
    }

    function avanzarManual() {
        document.getElementById('next-trigger').style.display = "none";
        next();
    }

    function next() {
        if (!current || step >= data[current].length) return;
        let t = data[current][step];
        let audioFile = "";

        if (step === 4) {
            let ops = ['a', 'b', 'c']; let r = Math.floor(Math.random() * 3);
            t = data[current][4][r];
            audioFile = `rp${current}_5${ops[r]}.m4a`;
        } else if (step === 5) {
            audioFile = `rp${current}_6.m4a`;
        } else {
            audioFile = `rp${current}_${step + 1}.m4a`;
        }

        document.getElementById('chat').innerHTML += `<div class="bubble ex"><b>Examinador:</b> ${t}</div>`;
        if (current === 1) playAudio(audioFile, t);
        else speak(t);
        
        let chatDiv = document.getElementById('chat');
        chatDiv.scrollTop = chatDiv.scrollHeight;
        step++;
    }

    function send() {
        // Si el micr√≥fono est√° encendido, lo apagamos a la fuerza
        if (recognition) {
            recognition.stop();
            document.getElementById('mic').style.background = '#1a237e';
        }

        let i = document.getElementById('box');
        if (!i.value) return;
        document.getElementById('chat').innerHTML += `<div class="bubble st">${i.value}</div>`;
        i.value = "";
        
        if (step < data[current].length) {
            document.getElementById('next-trigger').style.display = "block";
        }
    }

    function runMic() {
        let Reco = window.webkitSpeechRecognition || window.SpeechRecognition;
        if (!Reco) return alert("Micro no soportado");
        
        recognition = new Reco();
        recognition.lang = 'es-ES';
        recognition.continuous = false;
        recognition.interimResults = true;

        recognition.onstart = () => {
            document.getElementById('mic').style.background = 'red';
            document.getElementById('box').value = ""; 
        };

        recognition.onresult = (e) => {
            let text = "";
            for (let i = e.resultIndex; i < e.results.length; ++i) {
                text += e.results[i][0].transcript;
            }
            document.getElementById('box').value = text;
        };

        recognition.onend = () => {
            document.getElementById('mic').style.background = '#1a237e';
        };

        recognition.start();
    }
</script>
</body>
</html>
