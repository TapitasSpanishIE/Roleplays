<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LC Oral Master - Se√±or Mart√≠n</title>
    <style>
        :root { --primary: #1a237e; --secondary: #c62828; }
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f0f2f5; }
        header { background: var(--primary); color: white; padding: 12px; text-align: center; font-weight: bold; }
        .selector { display: flex; overflow-x: auto; gap: 8px; padding: 10px; background: #fff; border-bottom: 1px solid #ccc; flex-shrink: 0; }
        .rp-btn { min-width: 100px; padding: 12px; background: #f8f8f8; border: 1px solid #ddd; border-radius: 10px; font-size: 13px; cursor: pointer; }
        .active { background: var(--secondary) !important; color: white; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .bubble { max-width: 85%; padding: 14px; border-radius: 15px; font-size: 16px; line-height: 1.5; }
        .ex { align-self: flex-start; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-bottom-left-radius: 2px; }
        .st { align-self: flex-end; background: #dcf8c6; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-bottom-right-radius: 2px; }
        #next-trigger { display: none; margin: 15px auto; padding: 16px; background: var(--secondary); color: white; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; width: 85%; text-align: center; font-size: 16px; box-shadow: 0 4px 10px rgba(198,40,40,0.3); }
        .input-area { background: white; padding: 15px 15px 40px 15px; display: flex; gap: 12px; border-top: 1px solid #eee; }
        input { flex: 1; padding: 14px 20px; border-radius: 25px; border: 1px solid #ddd; font-size: 16px; outline: none; }
        input:disabled { background: #f0f0f0; }
        .btn-send { background: var(--primary); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 22px; cursor: pointer; flex-shrink: 0; }
        .btn-send:disabled { background: #ccc; }
    </style>
</head>
<body>

<header>Se√±or Mart√≠n: Simulador Oficial SEC</header>

<div class="selector">
    <div class="rp-btn" id="b1" onclick="seleccionarRP(1)">üè† 1. C√°ceres</div>
    <div class="rp-btn" id="b2" onclick="seleccionarRP(2)">üíª 2. √Åvila</div>
    <div class="rp-btn" id="b3" onclick="seleccionarRP(3)">üöê 3. Caravana</div>
    <div class="rp-btn" id="b4" onclick="seleccionarRP(4)">‚ôªÔ∏è 4. Pl√°sticos</div>
    <div class="rp-btn" id="b5" onclick="seleccionarRP(5)">üöó 5. Aver√≠a</div>
</div>

<div id="chat"></div>

<button id="next-trigger" onclick="proximaIntervencion()">Escuchar examinador ‚è©</button>

<div class="input-area">
    <input type="text" id="userInput" placeholder="Selecciona un escenario..." autocomplete="off" disabled>
    <button class="btn-send" onclick="enviarRespuesta()" disabled>‚ñ∂Ô∏è</button>
</div>

<script>
    let rpActual = null;
    let pasoActual = 0;
    let esperandoRespuesta = false;
    let speaking = false;

    const contenido = {
        1: ["¬°Hola, d√≠game!", "Entiendo que vas a estudiar un a√±o en C√°ceres. ¬øEn qu√© parte de la ciudad querr√≠as vivir?", "¬øPor qu√©?", "Tienes raz√≥n, pero C√°ceres es peque√±a y se puede ir andando a la Plaza Mayor en media hora desde las afueras.", ["¬øHas estado alguna vez en C√°ceres?", "¬øQu√© es lo que m√°s te gusta de vivir en Espa√±a?", "¬øPor qu√© quieres estudiar en Espa√±a?"], "Hemos terminado, gracias."],
        2: ["Buenos d√≠as. ¬øEn qu√© puedo ayudarte?", "¬øQu√© le ha pasado exactamente a la pantalla?", "¬øTienes copia de seguridad?", "Te lo arreglo hoy por 300‚Ç¨. ¬øQu√© te parece?", ["¬øUsas mucho el PC?", "¬øPrefieres Mac o Windows?", "¬øHas tenido problemas antes?"], "Examen finalizado."],
        3: ["Hola. ¬øQuieres alquilar una autocaravana?", "¬øQui√©n va a conducir?", "¬øTu madre ha tenido alg√∫n accidente?", "¬øQu√© ciudades quer√©is visitar?", ["¬øTe gusta acampar?", "¬øPrefieres verano o invierno?", "¬øHas conducido algo grande?"], "Role Play completado."],
        4: ["¬°Hola! ¬øPor qu√© est√°s tan contento?", "¬øCu√°ndo entra en vigor la prohibici√≥n europea?", "¬øQu√© materiales usar√≠as?", "Nosotros reciclamos siempre. ¬øY t√∫?", ["¬øTu colegio recicla?", "¬øQu√© opinas del cambio clim√°tico?", "¬øUsas cristal?"], "¬°Muy bien!"],
        5: ["¬°Hola, buenas tardes!", "¬øVes alguna se√±al de tr√°fico por la salida 156?", "¬øMe puedes describir tu coche?", "¬øLlevas mucho tiempo esperando?", ["¬øHas llamado a tu familia?", "¬øSabes cambiar una rueda?", "¬øConoces esta zona?"], "El mec√°nico llegar√° pronto."]
    };

    function setInputEnabled(enabled) {
        const input = document.getElementById('userInput');
        const btn = document.querySelector('.btn-send');
        input.disabled = !enabled;
        btn.disabled = !enabled;
        if (enabled) {
            input.placeholder = "Escribe o dicta aqu√≠...";
            setTimeout(() => input.focus(), 50);
        } else {
            input.placeholder = speaking ? "El examinador est√° hablando..." : "Esperando...";
        }
    }

    function seleccionarRP(id) {
        rpActual = id;
        pasoActual = 0;
        esperandoRespuesta = false;
        speaking = false;
        window.speechSynthesis.cancel();

        document.querySelectorAll('.rp-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('b' + id).classList.add('active');

        document.getElementById('chat').innerHTML = '<div class="bubble ex">Escenario seleccionado. Pulsa el bot√≥n rojo para empezar el examen.</div>';
        document.getElementById('next-trigger').style.display = "block";
        setInputEnabled(false);
    }

    function enviarRespuesta() {
        if (!rpActual || speaking || !esperandoRespuesta) return;

        const input = document.getElementById('userInput');
        const texto = input.value.trim();
        if (!texto) return;

        document.getElementById('chat').innerHTML += `<div class="bubble st">${texto}</div>`;
        input.value = "";
        document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;

        esperandoRespuesta = false;
        setInputEnabled(false);

        if (pasoActual < contenido[rpActual].length) {
            document.getElementById('next-trigger').style.display = "block";
        }
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') enviarRespuesta();
    });

    function proximaIntervencion() {
        if (!rpActual || speaking) return;

        document.getElementById('next-trigger').style.display = "none";
        let t = contenido[rpActual][pasoActual];
        let nombreAudio = "";

        if (pasoActual === 4) {
            let letras = ['a', 'b', 'c'];
            let r = Math.floor(Math.random() * 3);
            t = contenido[rpActual][4][r];
            nombreAudio = `rp${rpActual}_5${letras[r]}.m4a`;
        } else if (pasoActual === 5) {
            nombreAudio = `rp${rpActual}_6.m4a`;
        } else {
            nombreAudio = `rp${rpActual}_${pasoActual + 1}.m4a`;
        }

        document.getElementById('chat').innerHTML += `<div class="bubble ex"><b>Examinador:</b> ${t}</div>`;
        document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;

        speaking = true;
        setInputEnabled(false);

        const finalizarTurno = () => {
            speaking = false;
            pasoActual++;
            if (pasoActual < contenido[rpActual].length) {
                esperandoRespuesta = true;
                setInputEnabled(true);
            }
        };

        if (rpActual === 1) {
            const audio = new Audio(nombreAudio);
            audio.onended = finalizarTurno;
            
            // Si el archivo no carga o no existe, solo entonces usamos el robot
            audio.onerror = () => {
                hablarRobot(t, finalizarTurno);
            };

            audio.play().catch(() => {
                // Fallback por si el iPad bloquea el primer clic
                hablarRobot(t, finalizarTurno);
            });
        } else {
            hablarRobot(t, finalizarTurno);
        }
    }

    function hablarRobot(texto, onEndCb) {
        window.speechSynthesis.cancel();
        const m = new SpeechSynthesisUtterance(texto);
        m.lang = 'es-ES';
        m.rate = 0.9;
        m.onend = () => { if (onEndCb) onEndCb(); };
        window.speechSynthesis.speak(m);
    }
</script>
</body>
</html>
